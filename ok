<%- include('partials/header/world.ejs') %>

<div class="blockS">
    <% var avgRating; %>
            <% if(item.comments.length == 0){ %>
            <%  avgRating = 0; %>                                                  
            <% }else{ var i = 0,j= item.comments.length; %>
              <% item.comments.forEach(function(comment){ %>
                <% if(typeof(comment.rating) == 'undefined') { %>
                <% j-- %>
                <% } else { %>
                  <% i = i + comment.rating %>
                <% } %>
              <% }); %>
              <% avgRating = (i/j).toFixed(1) %>
            <% } %>
            <% if(isNaN(avgRating) || avgRating == 0){ %>
            <% avgRating=0 %>
            <% } %>
    <div class="row">
        <div>
        <img src='<%= item.image %>' height="400px" width="100%" class='card-img-top' style="object-fit: cover; border-radius: 12px;">
        <% var txtRate; %>
                <% if(avgRating == 0){ %>
                  <% txtRate='No one rate this product' %>
                  <% } else { %>
                  <% txtRate = avgRating + ' / 5.0' %>
                  <% } %>
        </div>
        <% if(!currentUser){ %>
            <form action='/user/favorite/add/<%= item.id %>' method='post' style="display: inline;">
              <button style="background-color: transparent; border: none;"><i class="far fa-heart"></i></button>
            </form>
          <% } else { %>
          <% if((currentUser.favorite).includes(item.id)) {%>
            <form action='/user/favorite/remove/<%= item.id %>' method='post' style="display: inline;">
              <button style="background-color: transparent; border: none;"><i class="fas fa-heart" style='color: red;'></i></button>
            </form>
          <% } else { %>
            <form action='/user/favorite/add/<%= item.id %>' method='post' style="display: inline;">
              <button style="background-color: transparent; border: none;"><i class="far fa-heart"></i></button>
            </form>
          <% } %>
          <% } %>
          <i class="fas fa-star" style='color: yellow;' title='<%= txtRate %>'></i>
        <div class="column">
            <p>Name : <%= item.name %></p>
            <p>Price : à¸¿<%= item.price%></p>
            <p>Category : <%= item.category %></p>
            <p>Stock : <%= item.stock %></p>
            <p>Description :<%= item.desc %></p>
            <div class="row">
                <p>Sell by : </p>
                <a href='/seller/shop/<%= item.author.id%>' class='text-decoration-none text-dark'>
                <% if(typeof(item.author.image) == 'undefined') { %>
                    <i class="fas fa-user me-3"></i><%= item.author.username %>
                <% } else { %>
                    <img src='<%= item.author.image %>' style='height: 20px; width: 20px; border-radius: 50%; object-fit:cover;'><%= item.author.username %>
                <% } %>
                </a>
            </div>
            
            <form action="/cart/<%= item._id %>/add" method="post">
                <p>Amount : <input type="number" class="ms-2" name='quantity' value="1" min='1' max='<%= item.stock %>'></p>
                <button type="submit" style = 'font-size: 20px; margin-left: 1rem;'>Add to my cart</button>
            </form>
        </div>
    </div>
</div>

<div class="blockC column" style="margin-top: -1rem;">
    <div class="underline">
    <h3>Comment</h3>
    <form action="/show/<%= item._id %>/comments" method="post">
        <div class='row'>
            <div >
                <input type="text" class=" " name="comment[text]" placeholder="Write your comment :)">
            </div>
            <div>
            <fieldset>
                <input type="radio" id="star1" name="comment[rating]" value="1" /><label id="label-rating" class = "full" for="star1" title="1 star"></label>
                <input type="radio" id="star2" name="comment[rating]" value="2" /><label id="label-rating" class = "full" for="star2" title="2 stars"></label>
                <input type="radio" id="star3" name="comment[rating]" value="3" /><label id="label-rating" class = "full" for="star3" title="3 stars"></label>
                <input type="radio" id="star4" name="comment[rating]" value="4" /><label id="label-rating" class = "full" for="star4" title="4 stars"></label>
                <input type="radio" id="star5" name="comment[rating]" value="5" /><label id="label-rating" class = "full" for="star5" title="5 stars"></label>
            </fieldset>
        </div>
            <div>
                <button type="submit">Submit</button>
            </div>
        </div>
    </form>
    </div>

    <div class="overflowY com">
        <div>
            <% item.comments.forEach((comment) => { %>
                    <div class='row'>
                        <p>
                            <% if(typeof(comment.author.image) == 'undefined') { %>
                                <i class="fas fa-user"></i>
                            <% } else { %>
                                <img src='<%= comment.author.image %>' style='height: 20px; width: 20px; border-radius: 50%; object-fit:cover;'>
                            <% } %>
                            <strong><%= comment.author.username %></strong>
                        </p>
                <% if(currentUser && comment.author.id.equals(currentUser._id)){ %>
                    <div class="row" style="margin-left: 80rem; margin-top: 0.3rem;">
                        <a data-toggle="reply-form" data-target="<%= comment.id %>-reply-form"><i class="fas fa-edit"></i><span>Edit</span></a>
                        <form onsubmit="if(!confirm('Are you sure?')){return false;}" action="/comment/<%= comment.id %>/delete" method='post'>
                            <button type='submit'><i class="fas fa-trash-alt"></i><span>Delete</span></button>
                        </form>
                    </div>
                <% } %>
                    </div>
                <div class='row underline'>
                    <p id="<%= comment.id%>-reply-form-2"><%= comment.text %></p>
                    <form action="/comment/<%=comment.id%>/edit" method="post" class="reply-form" id="<%= comment.id%>-reply-form">
                        <textarea rows="1" name='text'><%= comment.text %></textarea>
                        <div class='d-flex justify-content-end'>
                            <button type="button" class='btn btn-danger mx-2' data-toggle="reply-form" data-target="<%= comment.id%>-reply-form">Cancel</button>
                            <button type="submit" class='btn btn-primary'>Submit</button>
                        </div>
                    </form>
                    <div class='col-6 d-flex justify-content-start'>
                        <% var i; %>
                        <% for(i=1;i <= comment.rating;i++){ %>
                            <i class="fas fa-star" style='color: orange;'></i>
                        <% } %>
                    </div>
                    <p><%= comment.date %></p>
                </div>
            <% }); %>
        </div>
    </div>
</div>

    
<%- include('partials/footer/Main2.ejs') %>