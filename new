<%- include('partials/header/Search.ejs') %>

  <div class="block" style="margin-top: 3rem;">
    <div class="row">
      <div class="box">
        <h1>All result for "
          <span id='word' name='word'>
            <%= word %>
          </span>"
        </h1>
      </div>
      <div class="box sort">
        <span>Sort by</span>
        <select id='sort-by' onchange="sort()">
          <option value='none'>None</option>
          <option value='name'>Name</option>
          <option value='price-low'>Price low to high</option>
          <option value='price-high'>Price high to low</option>
          <option value='rating'>Rating</option>
        </select>
      </div>
      <div class="box filter">
        <span>Filter</span>
        <input type="number" onkeyup="liveSearch()" id='min' name="min" placeholder="Min">
        <input type="number" onkeyup="liveSearch()" id='max' name="max" placeholder="Max">
      </div>
    </div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3" id='myUL'>
      <% item.forEach((item) => { %>
          <% var avgRating; %>
          <% if(item.comments.length == 0){ %>
          <%  avgRating = 0; %>                                                  
          <% }else{ var i = 0,j= item.comments.length; %>
            <% item.comments.forEach(function(comment){ %>
              <% if(typeof(comment.rating) == 'undefined') { %>
              <% j-- %>
              <% } else { %>
                <% i = i + comment.rating %>
              <% } %>
            <% }); %>
            <% avgRating = (i/j).toFixed(1) %>
          <% } %>
          <% if(isNaN(avgRating) || avgRating == 0){ %>
          <% avgRating=0 %>
          <% } %>
      <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6 col-sm-12 search" data-none='<%= item.date%>' data-name='<%= item.name %>' data-price='<%= item.price %>' data-rating='<%= avgRating %>'>
        <div class="card shadow-sm px-2 pt-2 pb-0" style='border-radius: 12px;'>
          <div class='star-sm'>
            <img src='<%= item.image %>' height="200px" width="100%" class='card-img-top' style="object-fit: cover; border-radius: 12px;">
            <% var txtRate; %>
            <% if(avgRating == 0){ %>
              <% txtRate='No one rate this product' %>
              <% } else { %>
              <% txtRate = avgRating + ' / 5.0' %>
              <% } %>
            <div class='top-right-sm'>
              <% if(!currentUser){ %>
                <form action='/user/favorite/add/<%= item.id %>' method='post' style="display: inline;">
                  <button class='bg-transparent border-0'><i class="far fa-heart"></i></button>
                </form>
              <% } else { %>
              <% if((currentUser.favorite).includes(item.id)) {%>
                <form action='/user/favorite/remove/<%= item.id %>' method='post' style="display: inline;">
                  <button class='bg-transparent border-0'><i class="fas fa-heart" style='color: red;'></i></button>
                </form>
              <% } else { %>
                <form action='/user/favorite/add/<%= item.id %>' method='post' style="display: inline;">
                  <button class='bg-transparent border-0'><i class="far fa-heart"></i></button>
                </form>
              <% } %>
              <% } %>
                <i class="fas fa-star" style='color: orange; display: inline;' title='<%= txtRate %>'></i>
            </div>
          </div>
          <!-- <img src='<%= item.image %>' height="200px" width="100%" class='card-img-top' style="object-fit: cover; border-radius: 12px;"> -->
          <div class="card-body py-2 px-1">
            <h5 class='card-title item' style='min-height: 50px; max-height: 50px;'><%= item.name %></h5>
            <span class='cate' style='display: none;'><%= item.category %></span>
            <div class="d-flex justify-content-between align-items-center row">
              <div class="card-text col-10 d-block">
                <p class="">Sold : <%= item.sold %></p>
              </div>
              <div class="d-grid col-2 mb-3 justify-content-end">
                <a href = '/show/<%= item._id%>' class = "btn btn-sm btn-outline-secondary bg-view shadow-sm">View</a>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center row">
              <div class='col-6'>
                <h5 class="card-text justify-content-start">฿<span class='price'><%= item.price %></span></h5>
              </div>
              <div class="col-6 text-end">
                <form action="/cart/<%= item._id %>" method="post">
                  <button type="submit" class="btn btn-xl btn-primary login border border-0 px-1 shadow-sm">Add to cart</button>
                </form>
              </div>
            </div>
            <div class="mt-3 row">
              <span class='col-3'>By :</span>
              <div class='col-9 d-flex justify-content-end'>
                <a href='/seller/shop/<%= item.author.id%>' class='text-decoration-none text-dark'>
                <% if(typeof(item.author.image) == 'undefined') { %>
                  <i class="fas fa-user me-2" style='font-size: 25px;'></i><%= item.author.username %>
                <% } else { %>
                  <img  class='me-2'src='<%= item.author.image %>' style='height: 30px; width: 30px; border-radius: 50%; object-fit:cover;'><%= item.author.username %>
                <% } %>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
  </div>


  <%- include('partials/footer/Main2.ejs') %>



  <div class="detail">
    <div class="flex" style="margin-left:1rem"> 
      <h3  class="item"><%= item.name %></h3>
      <span class="cate">&nbsp;(<%= item.category %>)</span>
    </div>

    <div class="row flex-end">
      <div>
        <p class='price'>Price :<%= item.price %>฿</p>
      </div>
      <div>
        <p>Sold : <%= item.sold %></p>
      </div>
    </div>
    <div class="row" style="margin-left:2.5rem">
      <span class='col-3'>By :</span>
      <div>
        <a href='/seller/shop/<%= item.author.id%>'>
        <% if(typeof(item.author.image) == 'undefined') { %>
          <i class="fas fa-user me-2" style='font-size: 25px;'></i><%= item.author.username %>
        <% } else { %>
          <img src='<%= item.author.image %>' style='height: 20px; width: 20px; border-radius: 50%; object-fit:cover;'><%= item.author.username %>
        <% } %>
        </a>
      </div>
    </div>
    <div class="row flex-end">
      <div>
        <a href = '/show/<%= item._id%>'>> View < </a>
      </div>
      <div>
        <form action="/cart/<%= item._id %>" method="post">
          <button type="submit">Add to cart</button>
        </form>
      </div>
    </div>
  </div>